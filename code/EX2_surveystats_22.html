<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Corey Sparks, PhD">
<meta name="dcterms.date" content="2023-08-24">

<title>DEM 7283 - Example 1 - Survey Statistics using BRFSS data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="EX2_surveystats_22_files/libs/clipboard/clipboard.min.js"></script>
<script src="EX2_surveystats_22_files/libs/quarto-html/quarto.js"></script>
<script src="EX2_surveystats_22_files/libs/quarto-html/popper.min.js"></script>
<script src="EX2_surveystats_22_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="EX2_surveystats_22_files/libs/quarto-html/anchor.min.js"></script>
<link href="EX2_surveystats_22_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="EX2_surveystats_22_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="EX2_surveystats_22_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="EX2_surveystats_22_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="EX2_surveystats_22_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">DEM 7283 - Example 1 - Survey Statistics using BRFSS data</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Corey Sparks, PhD </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 24, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="what-is-a-survey" class="level2">
<h2 class="anchored" data-anchor-id="what-is-a-survey">What is a survey?</h2>
<p>A systematic method for gathering information from a sample of entities for the purposes of constructing quantitative descriptors of the attributes of the larger population of which the entities are members</p>
</section>
<section id="questions-when-identifying-a-survey-data-source" class="level2">
<h2 class="anchored" data-anchor-id="questions-when-identifying-a-survey-data-source">Questions when identifying a survey data source:</h2>
<ol type="1">
<li>What is the target population?</li>
<li>What is the sampling frame</li>
</ol>
<ul>
<li>how do we know who <strong><em>could</em></strong> be included?</li>
</ul>
<ol start="3" type="1">
<li>What is the sample design?</li>
<li>What is the mode of data collection?</li>
<li>Is the survey ongoing or a one-time collection?</li>
</ol>
</section>
<section id="core-concepts" class="level1">
<h1>Core Concepts</h1>
<p><strong><em>Sampling units</em></strong> - where information will be collected from</p>
<p><strong><em>Sampling frame</em></strong> - the set of sampling units containing distinct sets of population members</p>
</section>
<section id="weights-and-weighting" class="level1">
<h1>Weights and weighting</h1>
<p>Surveys with complex sample designs will often have:</p>
<ul>
<li>Unequal probabilities of selection</li>
<li>Variation in response rates across groups</li>
<li>Differences in distributions of characteristics compared to the population</li>
</ul>
<section id="weights-are-used-to-compensate-for-these-features" class="level3">
<h3 class="anchored" data-anchor-id="weights-are-used-to-compensate-for-these-features">Weights are used to compensate for these features</h3>
</section>
<section id="what-is-a-weight" class="level2">
<h2 class="anchored" data-anchor-id="what-is-a-weight">What is a weight?</h2>
<ul>
<li><p>A weight is used to indicate the relative strength of an observation.</p></li>
<li><p>In the simplest case, each observation is counted equally.</p></li>
<li><p>For example, if we have five observations, and wish to calculate the mean, we just add up the values and divide by 5.</p></li>
</ul>
<section id="dataset-with-5-cases" class="level3">
<h3 class="anchored" data-anchor-id="dataset-with-5-cases">Dataset with 5 cases</h3>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(htmlTable)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>y<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">2</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>wt<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>dat<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">y=</span>y, <span class="at">weight=</span>wt)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table">
<thead>
<tr class="header">
<th style="text-align: right;">y</th>
<th style="text-align: right;">weight</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
</div>
<p>Unweighted sample mean</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(dat<span class="sc">$</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.8</code></pre>
</div>
</div>
<p>Weighted sample mean</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(questionr)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wtd.mean</span>(<span class="at">x=</span>dat<span class="sc">$</span>y, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">weights=</span>dat<span class="sc">$</span>weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.1</code></pre>
</div>
</div>
</section>
</section>
<section id="difference-between-unweighted-and-weighted-data" class="level2">
<h2 class="anchored" data-anchor-id="difference-between-unweighted-and-weighted-data">Difference between unweighted and weighted data</h2>
<ul>
<li><p>With unweighted data, each case is counted equally.</p></li>
<li><p>Unweighted data represent only those in the sample who provide data.</p></li>
<li><p>With weighted data, each case is counted relative to its representation in the population.</p></li>
<li><p>Weights allow analyses that represent the target population.</p></li>
</ul>
<p>Weights compensate for collecting data from a sample rather than the entire population and for using a complex sample design.</p>
<p>Weights adjust for differential selection probabilities and reduce bias associated with non-response by adjusting for differential nonresponse. Weights are used when estimating characteristics of the population.</p>
</section>
<section id="sample-variance-estimation-in-complex-designs" class="level2">
<h2 class="anchored" data-anchor-id="sample-variance-estimation-in-complex-designs">Sample variance estimation in complex designs</h2>
<p><strong><em>Standard errors</em></strong> are produced for estimates from sample surveys. They are a measure of the variance in the estimates associated with the selected sample being one of many possible samples.</p>
<p>Standard errors are used to test hypotheses and to study group differences.</p>
<p>Using inaccurate standard errors can lead to identification of statistically significant results where none are present and vice versa</p>
</section>
<section id="complex-survey-designs-and-standard-errors" class="level2">
<h2 class="anchored" data-anchor-id="complex-survey-designs-and-standard-errors">Complex survey designs and standard errors</h2>
<ul>
<li><p>The usual standard error formula assumes a simple random sample.</p></li>
<li><p>Software packages designed for simple random samples tend to underestimate the standard errors for complex sample designs.</p></li>
<li><p>Standard errors for estimates from a complex sample must account for the within cluster/ across cluster variation.</p></li>
<li><p>Special software can make the adjustment, or this adjustment can be approximated using the design effect.</p></li>
</ul>
</section>
<section id="methods-for-sample-variance-estimation" class="level2">
<h2 class="anchored" data-anchor-id="methods-for-sample-variance-estimation">Methods for sample variance estimation</h2>
<p>There are basically 3 ways in which software estimates variances: 1) Naive method 2) Taylor series approximation 3) Balanced or Jackknife replication</p>
</section>
<section id="data-example" class="level2">
<h2 class="anchored" data-anchor-id="data-example">Data Example</h2>
<p>This example will cover the use of R functions for analyzing complex survey data. Most social and health surveys are not simple random samples of the population, but instead consist of respondents from a complex survey design.</p>
<p>These designs often stratify the population based on one or more characteristics, including geography, race, age, etc. In addition the designs can be multi-stage, meaning that initial strata are created, then respondents are sampled from smaller units within those strata.</p>
<p>An example would be if a school district was chosen as a sample strata, and then schools were then chosen as the primary sampling units (PSUs) within the district. From this 2 stage design, we could further sample classrooms within the school (3 stage design) or simply sample students (or whatever our unit of interest is).</p>
</section>
<section id="multi-stage-sampling" class="level2">
<h2 class="anchored" data-anchor-id="multi-stage-sampling">Multi-stage sampling</h2>
<ul>
<li><p>Non-random sampling</p></li>
<li><p>Population consists of known sub-groups called <em>clusters</em></p></li>
<li><p>A 2 -stage sample might be households within neighborhoods, or children within schools</p>
<ul>
<li>We may choose a random sample of schools/neighborhoods at the first stage, and a random sample of people within each school/neighborhood as the second stage</li>
<li>We need to be <em>careful</em> because the observations in the second stage are not <em>independent</em> of one another</li>
<li>Increased probability of selection for children in a selected school</li>
</ul></li>
<li><p>This type of sampling leads to <em>dependent</em> observations</p></li>
</ul>
<p>Here’s a picture of this:</p>
<p><img src="../images/MLdata.png" class="img-fluid"></p>
<p>A second feature of survey data we often want to account for is differential respondent weighting. This means that each respondent is given a weight to represent how common that particular respondent is within the population. This reflects the differenital probability of sampling based on respondent characteristics.</p>
<p>As demographers, we are also often interested in making inference for the population, not just the sample, so our results must be generalizable to the population at large. Sample weights are used in the process as well.</p>
<p>When such data are analyzed, we must take into account this nesting structure (sample design) as well as the respondent sample weight in order to make valid estimates of <strong>ANY</strong> statistical parameter. If we do not account for design, the parameter standard errors will be incorrect, and if we do not account for weighting, the parameters themselves will be incorrect and biased.</p>
<p>In general there are typically three things we need to find in our survey data codebooks: The sample strata identifier, the sample primary sampling unit identifier (often called a cluster identifier) and the respondent survey weight. These will typically have one of these names and should be easily identifiable in the codebook.</p>
<p>Statistical software will have special routines for analyzing these types of data and you must be aware that the diversity of statistical routines that generally exists will be lower for analyzing complex survey data, and some forms of analysis <em>may not be available!</em></p>
<p>See <a href="https://onlinelibrary.wiley.com/doi/book/10.1002/9780470580066">Thomas Lumley’s Book</a> on this!</p>
<p>Below I illustrate the use of survey characteristics when conducting descriptive analysis of a survey data set and a linear regression model estimated from that data. For this example I am using 2016 CDC Behavioral Risk Factor Surveillance System (BRFSS) SMART metro area survey data. <a href="https://www.cdc.gov/brfss/smart/smart_2016.html">Link</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#load brfss</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: carData</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stargazer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Please cite as: </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> Hlavac, Marek (2022). stargazer: Well-Formatted Regression and Summary Statistics Tables.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> R package version 5.2.3. https://CRAN.R-project.org/package=stargazer </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: grid</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: survival</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'survey'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:graphics':

    dotchart</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(questionr)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:car':

    recode</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forcats)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ ggplot2   3.4.2     ✔ stringr   1.5.0
✔ lubridate 1.9.2     ✔ tibble    3.2.1
✔ purrr     1.0.1     ✔ tidyr     1.3.0
✔ readr     2.1.4     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ tidyr::expand() masks Matrix::expand()
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
✖ tidyr::pack()   masks Matrix::pack()
✖ dplyr::recode() masks car::recode()
✖ purrr::some()   masks car::some()
✖ tidyr::unpack() masks Matrix::unpack()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtsummary)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set_gtsummary_theme</span>(<span class="fu">theme_gtsummary_compact</span>(<span class="at">set_theme =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting theme `Compact`
Setting theme `Compact`</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>brfss20<span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">url</span>(<span class="st">"https://github.com/coreysparks/DEM7283/blob/master/data/brfss20sm.rds?raw=true"</span>))</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="do">### Fix variable names</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(brfss20) <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">gsub</span>(<span class="at">pattern =</span> <span class="st">"_"</span>,<span class="at">replacement =</span>  <span class="st">""</span>,<span class="at">x =</span>  <span class="fu">names</span>(brfss20)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="recoding-of-variables" class="level3">
<h3 class="anchored" data-anchor-id="recoding-of-variables">Recoding of variables</h3>
<p>Be sure to always check your codebooks!</p>
<p>Here is the codebook for the BRFSS</p>
<iframe width="700" height="500" src="codebook20_llcp-v2-508.pdf" title="BRFSS 2020 Codebook">
</iframe>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Poor or fair self rated health</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>badhealth<span class="ot">&lt;-</span><span class="fu">Recode</span>(brfss20<span class="sc">$</span>genhlth, <span class="at">recodes=</span><span class="st">"4:5=1; 1:3=0; else=NA"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">#sex</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>male<span class="ot">&lt;-</span><span class="fu">as.factor</span>(<span class="fu">ifelse</span>(brfss20<span class="sc">$</span>sex<span class="sc">==</span><span class="dv">1</span>, <span class="st">"Male"</span>, <span class="st">"Female"</span>))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">#race/ethnicity</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>black<span class="ot">&lt;-</span><span class="fu">Recode</span>(brfss20<span class="sc">$</span>racegr3,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">recodes=</span><span class="st">"2=1; 9=NA; else=0"</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>white<span class="ot">&lt;-</span><span class="fu">Recode</span>(brfss20<span class="sc">$</span>racegr3, </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">recodes=</span><span class="st">"1=1; 9=NA; else=0"</span>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>other<span class="ot">&lt;-</span><span class="fu">Recode</span>(brfss20<span class="sc">$</span>racegr3,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>                      <span class="at">recodes=</span><span class="st">"3:4=1; 9=NA; else=0"</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>hispanic<span class="ot">&lt;-</span><span class="fu">Recode</span>(brfss20<span class="sc">$</span>racegr3,</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>                         <span class="at">recodes=</span><span class="st">"5=1; 9=NA; else=0"</span>)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>race_eth<span class="ot">&lt;-</span><span class="fu">Recode</span>(brfss20<span class="sc">$</span>racegr3,</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="at">recodes=</span><span class="st">"1='nhwhite'; 2='nh black'; 3='nh other';4='nh multirace'; 5='hispanic'; else=NA"</span>,</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="at">as.factor =</span> T)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>race_eth<span class="ot">&lt;-</span><span class="fu">relevel</span>(brfss20<span class="sc">$</span>race_eth,</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>                          <span class="at">ref =</span> <span class="st">"nhwhite"</span>)</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="co">#insurance</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>ins<span class="ot">&lt;-</span><span class="fu">Recode</span>(brfss20<span class="sc">$</span>hlthpln1,</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>                    <span class="at">recodes =</span><span class="st">"7:9=NA; 1=1;2=0"</span>)</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="co">#income grouping</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>inc<span class="ot">&lt;-</span><span class="fu">ifelse</span>(brfss20<span class="sc">$</span>incomg<span class="sc">==</span><span class="dv">9</span>,</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>                    <span class="cn">NA</span>,</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>                    brfss20<span class="sc">$</span>incomg)</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a><span class="co">#education level</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>educ<span class="ot">&lt;-</span><span class="fu">Recode</span>(brfss20<span class="sc">$</span>educa,</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>                     <span class="at">recodes=</span><span class="st">"1:2='0Prim'; 3='1somehs'; 4='2hsgrad'; 5='3somecol'; 6='4colgrad';9=NA"</span>,</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>                     <span class="at">as.factor=</span>T)</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>educ<span class="ot">&lt;-</span><span class="fu">fct_relevel</span>(brfss20<span class="sc">$</span>educ,<span class="st">'0Prim'</span>,<span class="st">'1somehs'</span>,<span class="st">'2hsgrad'</span>,<span class="st">'3somecol'</span>,<span class="st">'4colgrad'</span> ) </span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a><span class="co">#employment</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>employ<span class="ot">&lt;-</span><span class="fu">Recode</span>(brfss20<span class="sc">$</span>employ1,</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>                       <span class="at">recodes=</span><span class="st">"1:2='Employed'; 2:6='nilf'; 7='retired'; 8='unable'; else=NA"</span>,</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>                       <span class="at">as.factor=</span>T)</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>employ<span class="ot">&lt;-</span><span class="fu">relevel</span>(brfss20<span class="sc">$</span>employ, <span class="at">ref=</span><span class="st">'Employed'</span>)</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a><span class="co">#marital status</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>marst<span class="ot">&lt;-</span><span class="fu">Recode</span>(brfss20<span class="sc">$</span>marital,</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>                      <span class="at">recodes=</span><span class="st">"1='married'; 2='divorced'; 3='widowed'; 4='separated'; 5='nm';6='cohab'; else=NA"</span>,</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>                      <span class="at">as.factor=</span>T)</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>marst<span class="ot">&lt;-</span><span class="fu">relevel</span>(brfss20<span class="sc">$</span>marst, <span class="at">ref=</span><span class="st">'married'</span>)</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a><span class="co">#Age cut into intervals</span></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>agec<span class="ot">&lt;-</span><span class="fu">cut</span>(brfss20<span class="sc">$</span>age80, </span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>                  <span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">24</span>,<span class="dv">39</span>,<span class="dv">59</span>,<span class="dv">79</span>,<span class="dv">99</span>))</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a><span class="co">#BMI, in the brfss20 the bmi variable has 2 implied decimal places, so we must divide by 100 to get real bmi's</span></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>bmi<span class="ot">&lt;-</span>brfss20<span class="sc">$</span>bmi5<span class="sc">/</span><span class="dv">100</span></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>obese<span class="ot">&lt;-</span><span class="fu">ifelse</span>(brfss20<span class="sc">$</span>bmi<span class="sc">&gt;=</span><span class="dv">30</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="filter-cases" class="level3">
<h3 class="anchored" data-anchor-id="filter-cases">Filter cases</h3>
<p>The <code>is.na()</code> function is very helpful to find missing values. The code below filters out anyone who is missing for the sex variable <code>(sex != 9)</code> or is missing the <code>educ</code> or <code>badhealth</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>brfss20<span class="ot">&lt;-</span>brfss20<span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sex<span class="sc">!=</span><span class="dv">9</span>,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>         <span class="fu">is.na</span>(educ)<span class="sc">==</span>F,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">is.na</span>(badhealth)<span class="sc">==</span>F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="analysis" class="level3">
<h3 class="anchored" data-anchor-id="analysis">Analysis</h3>
<p>First, we will do some descriptive analysis, such as means and cross tabulations. There are <em>LOTS</em> of ways to do this. The <code>table()</code> function is an easy and cheap way to get frequencies of a variable. It will return the count of the frequency of the levels of a variable. This can be called a <em>R by C</em> table, for <em>Rows by Columns</em>. The simplest version of this is a a 2*2 table when both variables have only two response levels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(brfss20<span class="sc">$</span>badhealth, brfss20<span class="sc">$</span>male)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   
    Female  Male
  0  89115 78286
  1  15207 11292</code></pre>
</div>
</div>
<p>Here is another table of the health status by level of education.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Raw frequencies of bad health by education</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(brfss20<span class="sc">$</span>badhealth, brfss20<span class="sc">$</span>educ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   
    0Prim 1somehs 2hsgrad 3somecol 4colgrad
  0  2398    4983   37371    43861    78788
  1  1438    2295    8700     7672     6394</code></pre>
</div>
</div>
<p>This is not terribly useful, and we typically want proportions.</p>
<p>The <code>prop.table()</code> function will form proportions of a table made from <code>table()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#column percentages</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="dv">100</span><span class="sc">*</span><span class="fu">prop.table</span>(<span class="fu">table</span>(brfss20<span class="sc">$</span>badhealth, brfss20<span class="sc">$</span>educ), <span class="at">margin=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   
        0Prim   1somehs   2hsgrad  3somecol  4colgrad
  0 62.513034 68.466612 81.116103 85.112452 92.493719
  1 37.486966 31.533388 18.883897 14.887548  7.506281</code></pre>
</div>
</div>
<p>We see from this that a higher proportion of people with primary school education have fair or poor health compared to those with more education.</p>
</section>
<section id="bivariate-tests-of-independence" class="level3">
<h3 class="anchored" data-anchor-id="bivariate-tests-of-independence">Bivariate tests of independence</h3>
<p>One of the most elementary statistical test for categorical data is the <span class="math inline">\(\chi^2\)</span> test. It tests for independence of two or more categorical variables, tabulated in a <code>table()</code> analysis. We call this a <em>bi-variate</em> test usually because we consider two variables,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#basic chi square test of independence</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">chisq.test</span>(<span class="fu">table</span>(brfss20<span class="sc">$</span>badhealth, brfss20<span class="sc">$</span>educ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Pearson's Chi-squared test

data:  table(brfss20$badhealth, brfss20$educ)
X-squared = 7681.7, df = 4, p-value &lt; 2.2e-16</code></pre>
</div>
</div>
<p>So the <span class="math inline">\(\chi^2\)</span> statistic is large and the p - value associated with it is <em>very</em> small, suggesting that the health indicator is not independent of education.</p>
</section>
</section>
</section>
<section id="some-bad-news" class="level1">
<h1>Some bad news</h1>
<p>So basically all of these numbers are incorrect, since they all assume random sampling. Now, we must tell R what the survey design is and what the weight variable is, then we can re-do these so they are correct.</p>
<section id="create-a-survey-design-object" class="level2">
<h2 class="anchored" data-anchor-id="create-a-survey-design-object">Create a survey design object</h2>
<p>Now we identify the survey design.</p>
<p><em>ids</em> = PSU identifers, <em>strata</em>=strata identifiers, <em>weights</em>=sampling weights, <em>data</em>= the data frame where these variables are located.</p>
<p>Lastly, I only include respondents with NON-MISSING case weights.</p>
<p>Now I make the survey design object. You may be required to specify two options here:</p>
<ol type="1">
<li><p><code>survey.lonely.psu</code> This means that some of the strata only have 1 PSU within them. This does not allow for within strata variance to be calculated. So we often have to tell the computer to do something here. Two valid options are “adjust”, to center the stratum at the population mean rather than the stratum mean, and “average” to replace the variance contribution of the stratum by the average variance contribution across strata. (from <code>?surveyoptions</code>)</p></li>
<li><p>Nesting of PSU within strata. By default, PSUs have numeric identifiers that can overlap between strata. By specifying <code>nest=T</code>, we tell R to re-lable the PSUs so they are unique across strata. If your survey requires this, it will throw a warning message.</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(srvyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'srvyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:stats':

    filter</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">survey.lonely.psu =</span> <span class="st">"adjust"</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">$</span>crap <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">193900</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>des<span class="ot">&lt;-</span><span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span><span class="dv">1</span>,  <span class="at">strata=</span><span class="sc">~</span>ststr, <span class="at">weights=</span><span class="sc">~</span>mmsawt, <span class="at">data =</span> brfss20 )</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>des</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Stratified Independent Sampling design (with replacement)
svydesign(ids = ~1, strata = ~ststr, weights = ~mmsawt, data = brfss20)</code></pre>
</div>
</div>
<section id="simple-weighted-analysis" class="level3">
<h3 class="anchored" data-anchor-id="simple-weighted-analysis">Simple weighted analysis</h3>
<p>Now , we re-do the analysis from above using only weights:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#counts</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>cat<span class="ot">&lt;-</span><span class="fu">wtd.table</span>(brfss20<span class="sc">$</span>badhealth,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>               brfss20<span class="sc">$</span>educ,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">weights =</span> brfss20<span class="sc">$</span>mmsawt)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">#proportions</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  cat,</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">margin=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       0Prim    1somehs    2hsgrad   3somecol   4colgrad
0 0.65224707 0.72493928 0.84189380 0.87352602 0.93825022
1 0.34775293 0.27506072 0.15810620 0.12647398 0.06174978</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">#compare that with the original, unweighted proportions</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(brfss20<span class="sc">$</span>badhealth,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                 brfss20<span class="sc">$</span>educ),</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">margin=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   
         0Prim    1somehs    2hsgrad   3somecol   4colgrad
  0 0.62513034 0.68466612 0.81116103 0.85112452 0.92493719
  1 0.37486966 0.31533388 0.18883897 0.14887548 0.07506281</code></pre>
</div>
</div>
<p>There <strong>are</strong> differences, notably that the prevalence of poor SRH is <em>higher in the sample than the population</em>. This is important!</p>
</section>
<section id="proper-survey-design-analysis" class="level3">
<h3 class="anchored" data-anchor-id="proper-survey-design-analysis">Proper survey design analysis</h3>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Now consider the full sample design + weights</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>cat<span class="ot">&lt;-</span><span class="fu">svyby</span>(<span class="at">formula =</span> <span class="sc">~</span>badhealth,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">by=</span><span class="sc">~</span>educ,</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">design =</span> des,</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">FUN=</span>svymean)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="fu">svychisq</span>(<span class="sc">~</span>badhealth<span class="sc">+</span>educ, <span class="at">design =</span> des)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>Pearson's X^2: Rao &amp; Scott adjustment</code></pre>
<p>data: svychisq(~badhealth + educ, design = des) F = 343.93, ndf = 3.1456e+00, ddf = 6.0621e+05, p-value &lt; 2.2e-16</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(cat,</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Survey Estimates of Poor SRH by Sex"</span>,</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">'c'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Survey Estimates of Poor SRH by Sex</caption>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: center;">educ</th>
<th style="text-align: center;">badhealth</th>
<th style="text-align: center;">se</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0Prim</td>
<td style="text-align: center;">0Prim</td>
<td style="text-align: center;">0.3477529</td>
<td style="text-align: center;">0.0182995</td>
</tr>
<tr class="even">
<td style="text-align: left;">1somehs</td>
<td style="text-align: center;">1somehs</td>
<td style="text-align: center;">0.2750607</td>
<td style="text-align: center;">0.0100143</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2hsgrad</td>
<td style="text-align: center;">2hsgrad</td>
<td style="text-align: center;">0.1581062</td>
<td style="text-align: center;">0.0034489</td>
</tr>
<tr class="even">
<td style="text-align: left;">3somecol</td>
<td style="text-align: center;">3somecol</td>
<td style="text-align: center;">0.1264740</td>
<td style="text-align: center;">0.0029230</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4colgrad</td>
<td style="text-align: center;">4colgrad</td>
<td style="text-align: center;">0.0617498</td>
<td style="text-align: center;">0.0015838</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Which gives the same %’s as the weighted table above, but we also want the correct standard errors for our bad health prevalence.</p>
<p>The <code>svyby()</code> function will calculate statistics by groups, in this case we want the % in bad health by each level of education. The %’s can be gotten using the <code>svymean()</code> function, which finds means of variables using survey design:</p>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>sv.table<span class="ot">&lt;-</span><span class="fu">svyby</span>(<span class="at">formula =</span> <span class="sc">~</span>badhealth,</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="sc">~</span>educ,</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">design =</span> des,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">FUN =</span> svymean,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">na.rm=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(sv.table,</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Survey Estimates of Poor SRH by Education"</span>,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">'c'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Survey Estimates of Poor SRH by Education</caption>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: center;">educ</th>
<th style="text-align: center;">badhealth</th>
<th style="text-align: center;">se</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0Prim</td>
<td style="text-align: center;">0Prim</td>
<td style="text-align: center;">0.3477529</td>
<td style="text-align: center;">0.0182995</td>
</tr>
<tr class="even">
<td style="text-align: left;">1somehs</td>
<td style="text-align: center;">1somehs</td>
<td style="text-align: center;">0.2750607</td>
<td style="text-align: center;">0.0100143</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2hsgrad</td>
<td style="text-align: center;">2hsgrad</td>
<td style="text-align: center;">0.1581062</td>
<td style="text-align: center;">0.0034489</td>
</tr>
<tr class="even">
<td style="text-align: left;">3somecol</td>
<td style="text-align: center;">3somecol</td>
<td style="text-align: center;">0.1264740</td>
<td style="text-align: center;">0.0029230</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4colgrad</td>
<td style="text-align: center;">4colgrad</td>
<td style="text-align: center;">0.0617498</td>
<td style="text-align: center;">0.0015838</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Make a survey design that is random sampling - no survey information</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>nodes<span class="ot">&lt;-</span><span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span><span class="dv">1</span>,  <span class="at">weights =</span> <span class="sc">~</span><span class="dv">1</span>, <span class="at">data =</span> brfss20)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>sv.table<span class="ot">&lt;-</span><span class="fu">svyby</span>(<span class="at">formula =</span> <span class="sc">~</span><span class="fu">factor</span>(badhealth),</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="sc">~</span>educ,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">design =</span> nodes,</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">FUN =</span> svymean,</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">na.rm=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(sv.table,</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Estimates of Poor SRH by Education - No survey design"</span>,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">'c'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Estimates of Poor SRH by Education - No survey design</caption>
<colgroup>
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 19%">
<col style="width: 19%">
<col style="width: 21%">
<col style="width: 21%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: center;">educ</th>
<th style="text-align: center;">factor(badhealth)0</th>
<th style="text-align: center;">factor(badhealth)1</th>
<th style="text-align: center;">se.factor(badhealth)0</th>
<th style="text-align: center;">se.factor(badhealth)1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0Prim</td>
<td style="text-align: center;">0Prim</td>
<td style="text-align: center;">0.6251303</td>
<td style="text-align: center;">0.3748697</td>
<td style="text-align: center;">0.0078160</td>
<td style="text-align: center;">0.0078160</td>
</tr>
<tr class="even">
<td style="text-align: left;">1somehs</td>
<td style="text-align: center;">1somehs</td>
<td style="text-align: center;">0.6846661</td>
<td style="text-align: center;">0.3153339</td>
<td style="text-align: center;">0.0054465</td>
<td style="text-align: center;">0.0054465</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2hsgrad</td>
<td style="text-align: center;">2hsgrad</td>
<td style="text-align: center;">0.8111610</td>
<td style="text-align: center;">0.1888390</td>
<td style="text-align: center;">0.0018234</td>
<td style="text-align: center;">0.0018234</td>
</tr>
<tr class="even">
<td style="text-align: left;">3somecol</td>
<td style="text-align: center;">3somecol</td>
<td style="text-align: center;">0.8511245</td>
<td style="text-align: center;">0.1488755</td>
<td style="text-align: center;">0.0015681</td>
<td style="text-align: center;">0.0015681</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4colgrad</td>
<td style="text-align: center;">4colgrad</td>
<td style="text-align: center;">0.9249372</td>
<td style="text-align: center;">0.0750628</td>
<td style="text-align: center;">0.0009028</td>
<td style="text-align: center;">0.0009028</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>And we see the same point estimates of our prevalences as in the simple weighted table, but the standard errors have now been adjusted for survey design as well, so they are also correct. You also see they are much larger than the ones we computed above, which assumed random sampling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Make a survey design that is random sampling - no survey information</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>des<span class="ot">&lt;-</span><span class="fu">svydesign</span>(<span class="at">ids =</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">strata =</span> <span class="sc">~</span>ststr,  <span class="at">weights =</span> <span class="sc">~</span>mmsawt, <span class="at">data =</span> brfss20)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>sv.table2<span class="ot">&lt;-</span><span class="fu">svyby</span>(<span class="at">formula =</span> <span class="sc">~</span><span class="fu">factor</span>(badhealth),</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="sc">~</span>educ,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">design =</span> des,</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">FUN =</span> svymean,</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">na.rm=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(sv.table2,</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Estimates of Poor SRH by Education - With survey design"</span>,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">'c'</span>,  </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">format =</span> <span class="st">"html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Estimates of Poor SRH by Education - With survey design</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: center;" data-quarto-table-cell-role="th">educ</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">factor(badhealth)0</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">factor(badhealth)1</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">se.factor(badhealth)0</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">se.factor(badhealth)1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0Prim</td>
<td style="text-align: center;">0Prim</td>
<td style="text-align: center;">0.6522471</td>
<td style="text-align: center;">0.3477529</td>
<td style="text-align: center;">0.0182995</td>
<td style="text-align: center;">0.0182995</td>
</tr>
<tr class="even">
<td style="text-align: left;">1somehs</td>
<td style="text-align: center;">1somehs</td>
<td style="text-align: center;">0.7249393</td>
<td style="text-align: center;">0.2750607</td>
<td style="text-align: center;">0.0100143</td>
<td style="text-align: center;">0.0100143</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2hsgrad</td>
<td style="text-align: center;">2hsgrad</td>
<td style="text-align: center;">0.8418938</td>
<td style="text-align: center;">0.1581062</td>
<td style="text-align: center;">0.0034489</td>
<td style="text-align: center;">0.0034489</td>
</tr>
<tr class="even">
<td style="text-align: left;">3somecol</td>
<td style="text-align: center;">3somecol</td>
<td style="text-align: center;">0.8735260</td>
<td style="text-align: center;">0.1264740</td>
<td style="text-align: center;">0.0029230</td>
<td style="text-align: center;">0.0029230</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4colgrad</td>
<td style="text-align: center;">4colgrad</td>
<td style="text-align: center;">0.9382502</td>
<td style="text-align: center;">0.0617498</td>
<td style="text-align: center;">0.0015838</td>
<td style="text-align: center;">0.0015838</td>
</tr>
</tbody>
</table>


</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>sv1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">param =</span> sv.table[, <span class="dv">1</span>],</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">se =</span> <span class="fu">c</span>(sv.table[, <span class="dv">5</span>], sv.table2[,<span class="dv">5</span>]),</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">group =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"nodes"</span>,<span class="dv">5</span>), <span class="fu">rep</span>(<span class="st">"des"</span>, <span class="dv">5</span>)))</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>sv1<span class="sc">%&gt;%</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>param,<span class="at">y=</span>se, <span class="at">fill=</span>group))<span class="sc">+</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="EX2_surveystats_22_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="another-way" class="level3">
<h3 class="anchored" data-anchor-id="another-way">Another way</h3>
<p>There’s this great R package, <code>tableone</code> that does this stuff very nicely and incorporates survey design too. Here’s an example of using it to generate your bi-variate tests like above:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tableone)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co">#not using survey design</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>t1<span class="ot">&lt;-</span><span class="fu">CreateTableOne</span>(<span class="at">vars =</span> <span class="fu">c</span>( <span class="st">"badhealth"</span>),</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">strata=</span><span class="st">"educ"</span>,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> brfss20)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="co">#t1&lt;-print(t1, format="p")</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(t1,<span class="at">format=</span><span class="st">"p"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       Stratified by educ
                        0Prim       1somehs     2hsgrad      3somecol    
  n                     3836        7278        46071        51533       
  badhealth (mean (SD)) 0.37 (0.48) 0.32 (0.46)  0.19 (0.39)  0.15 (0.36)
                       Stratified by educ
                        4colgrad     p      test
  n                     85182                   
  badhealth (mean (SD))  0.08 (0.26) &lt;0.001     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">#, strata = "badhealth", test = T,</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">#using survey design</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>st1<span class="ot">&lt;-</span><span class="fu">svyCreateTableOne</span>(<span class="at">vars =</span> <span class="fu">c</span>(<span class="st">"badhealth"</span>),</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">strata =</span> <span class="st">"educ"</span>,</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">test =</span> T,</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> des)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(st1,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">format=</span><span class="st">"p"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       Stratified by educ
                        0Prim             1somehs            2hsgrad           
  n                     6688472.52        10662249.38        38002206.55       
  badhealth (mean (SD))       0.35 (0.48)        0.28 (0.45)        0.16 (0.36)
                       Stratified by educ
                        3somecol           4colgrad           p      test
  n                     44184385.27        49844844.72                   
  badhealth (mean (SD))        0.13 (0.33)        0.06 (0.24) &lt;0.001     </code></pre>
</div>
</div>
<p>When reporting descriptive statistics, these are the correct summaries to provide.</p>
</section>
</section>
<section id="using-dplyr-and-tidyverse" class="level2">
<h2 class="anchored" data-anchor-id="using-dplyr-and-tidyverse">Using dplyr and tidyverse</h2>
<p>You can include survey design information directly into a <code>dplyr</code> pipe using the <code>srvyr</code> package. To generate survey corrected frequencies or means, the traditional <code>group_by()</code> and <code>summarise()</code> are your friends.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(srvyr)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">%&gt;%</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_survey_design</span>(<span class="at">strata =</span> ststr,</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">weights =</span> mmsawt)<span class="sc">%&gt;%</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(educ, male)<span class="sc">%&gt;%</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_bh =</span> <span class="fu">survey_mean</span>(badhealth, <span class="at">na.rm=</span>T))<span class="sc">%&gt;%</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()<span class="sc">%&gt;%</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>educ, <span class="at">y =</span> mean_bh, <span class="at">fill=</span>male))<span class="sc">+</span><span class="fu">geom_col</span>(<span class="at">position=</span><span class="st">"dodge"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="EX2_surveystats_22_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="yet-another-way" class="level3">
<h3 class="anchored" data-anchor-id="yet-another-way">Yet another way</h3>
<p>The package <code>gtsummary</code> package provides a wonderful way to summarise and create tables from a survey data source.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtsummary)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>brfss20<span class="sc">%&gt;%</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bh =</span> <span class="fu">as.factor</span>(badhealth))<span class="sc">%&gt;%</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_survey_design</span>( <span class="at">strata =</span>ststr,</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">weights =</span> mmsawt)<span class="sc">%&gt;%</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(bh, educ)<span class="sc">%&gt;%</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_svysummary</span>(<span class="at">by =</span> educ, </span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">label =</span> <span class="fu">list</span>(<span class="at">badhealth =</span> <span class="st">"Fair/Poor Health"</span>),</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">statistic =</span> <span class="fu">list</span>(<span class="fu">all_categorical</span>() <span class="sc">~</span> <span class="st">"{n} ({p}%)"</span>))<span class="sc">%&gt;%</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_p</span>()<span class="sc">%&gt;%</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add_n()%&gt;%</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">modify_header</span>(<span class="fu">all_stat_cols</span>() <span class="sc">~</span> <span class="st">"**{level}**"</span>)<span class="sc">%&gt;%</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">bold_labels</span>() <span class="sc">%&gt;%</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">modify_spanning_header</span>(<span class="fu">all_stat_cols</span>() <span class="sc">~</span> <span class="st">"**Educational Attainment**"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="hxivqnscse" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#hxivqnscse table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#hxivqnscse thead, #hxivqnscse tbody, #hxivqnscse tfoot, #hxivqnscse tr, #hxivqnscse td, #hxivqnscse th {
  border-style: none;
}

#hxivqnscse p {
  margin: 0;
  padding: 0;
}

#hxivqnscse .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 13px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#hxivqnscse .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#hxivqnscse .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#hxivqnscse .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#hxivqnscse .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hxivqnscse .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hxivqnscse .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hxivqnscse .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#hxivqnscse .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#hxivqnscse .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#hxivqnscse .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#hxivqnscse .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#hxivqnscse .gt_spanner_row {
  border-bottom-style: hidden;
}

#hxivqnscse .gt_group_heading {
  padding-top: 1px;
  padding-bottom: 1px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#hxivqnscse .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#hxivqnscse .gt_from_md > :first-child {
  margin-top: 0;
}

#hxivqnscse .gt_from_md > :last-child {
  margin-bottom: 0;
}

#hxivqnscse .gt_row {
  padding-top: 1px;
  padding-bottom: 1px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#hxivqnscse .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#hxivqnscse .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#hxivqnscse .gt_row_group_first td {
  border-top-width: 2px;
}

#hxivqnscse .gt_row_group_first th {
  border-top-width: 2px;
}

#hxivqnscse .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 1px;
  padding-bottom: 1px;
  padding-left: 5px;
  padding-right: 5px;
}

#hxivqnscse .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#hxivqnscse .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#hxivqnscse .gt_last_summary_row {
  padding-top: 1px;
  padding-bottom: 1px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hxivqnscse .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 1px;
  padding-bottom: 1px;
  padding-left: 5px;
  padding-right: 5px;
}

#hxivqnscse .gt_first_grand_summary_row {
  padding-top: 1px;
  padding-bottom: 1px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#hxivqnscse .gt_last_grand_summary_row_top {
  padding-top: 1px;
  padding-bottom: 1px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#hxivqnscse .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#hxivqnscse .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hxivqnscse .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hxivqnscse .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 1px;
  padding-bottom: 1px;
  padding-left: 5px;
  padding-right: 5px;
}

#hxivqnscse .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hxivqnscse .gt_sourcenote {
  font-size: 90%;
  padding-top: 1px;
  padding-bottom: 1px;
  padding-left: 5px;
  padding-right: 5px;
}

#hxivqnscse .gt_left {
  text-align: left;
}

#hxivqnscse .gt_center {
  text-align: center;
}

#hxivqnscse .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#hxivqnscse .gt_font_normal {
  font-weight: normal;
}

#hxivqnscse .gt_font_bold {
  font-weight: bold;
}

#hxivqnscse .gt_font_italic {
  font-style: italic;
}

#hxivqnscse .gt_super {
  font-size: 65%;
}

#hxivqnscse .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#hxivqnscse .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#hxivqnscse .gt_indent_1 {
  text-indent: 5px;
}

#hxivqnscse .gt_indent_2 {
  text-indent: 10px;
}

#hxivqnscse .gt_indent_3 {
  text-indent: 15px;
}

#hxivqnscse .gt_indent_4 {
  text-indent: 20px;
}

#hxivqnscse .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings gt_spanner_row">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="2" colspan="1" scope="col" id="<strong>Characteristic</strong>"><strong>Characteristic</strong></th>
      <th class="gt_center gt_columns_top_border gt_column_spanner_outer" rowspan="1" colspan="5" scope="colgroup" id="<strong>Educational Attainment</strong>">
        <span class="gt_column_spanner"><strong>Educational Attainment</strong></span>
      </th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="2" colspan="1" scope="col" id="<strong>p-value</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>2</sup></span>"><strong>p-value</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>2</sup></span></th>
    </tr>
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>0Prim</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>"><strong>0Prim</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>1somehs</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>"><strong>1somehs</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>2hsgrad</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>"><strong>2hsgrad</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>3somecol</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>"><strong>3somecol</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="<strong>4colgrad</strong><span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;><sup>1</sup></span>"><strong>4colgrad</strong><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span></th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="label" class="gt_row gt_left" style="font-weight: bold;">bh</td>
<td headers="stat_1" class="gt_row gt_center"></td>
<td headers="stat_2" class="gt_row gt_center"></td>
<td headers="stat_3" class="gt_row gt_center"></td>
<td headers="stat_4" class="gt_row gt_center"></td>
<td headers="stat_5" class="gt_row gt_center"></td>
<td headers="p.value" class="gt_row gt_center">&lt;0.001</td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;0</td>
<td headers="stat_1" class="gt_row gt_center">4,362,537 (65%)</td>
<td headers="stat_2" class="gt_row gt_center">7,729,483 (72%)</td>
<td headers="stat_3" class="gt_row gt_center">31,993,822 (84%)</td>
<td headers="stat_4" class="gt_row gt_center">38,596,210 (87%)</td>
<td headers="stat_5" class="gt_row gt_center">46,766,936 (94%)</td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
    <tr><td headers="label" class="gt_row gt_left">&nbsp;&nbsp;&nbsp;&nbsp;1</td>
<td headers="stat_1" class="gt_row gt_center">2,325,936 (35%)</td>
<td headers="stat_2" class="gt_row gt_center">2,932,766 (28%)</td>
<td headers="stat_3" class="gt_row gt_center">6,008,385 (16%)</td>
<td headers="stat_4" class="gt_row gt_center">5,588,175 (13%)</td>
<td headers="stat_5" class="gt_row gt_center">3,077,908 (6.2%)</td>
<td headers="p.value" class="gt_row gt_center"></td></tr>
  </tbody>
  
  <tfoot class="gt_footnotes">
    <tr>
      <td class="gt_footnote" colspan="7"><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>1</sup></span> n (%)</td>
    </tr>
    <tr>
      <td class="gt_footnote" colspan="7"><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;"><sup>2</sup></span> chi-squared test with Rao &amp; Scott’s second-order correction</td>
    </tr>
  </tfoot>
</table>
</div>
</div>
</div>
<p>Which produces a nice table showing the mean of the outcome, as well as a survey-corrected test of independence.</p>
</section>
</section>
<section id="regression-example" class="level2">
<h2 class="anchored" data-anchor-id="regression-example">Regression example</h2>
<p>Next we apply this logic to a regression case. First we fit the OLS model for our BMI outcome using education and age as predictors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>fit1<span class="ot">&lt;-</span><span class="fu">lm</span>(bmi<span class="sc">~</span>educ<span class="sc">+</span>agec,</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">data=</span>brfss20)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we incorporate case weights</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>fit2<span class="ot">&lt;-</span><span class="fu">lm</span>(bmi<span class="sc">~</span>educ<span class="sc">+</span>agec,</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">data=</span>brfss20,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">weights =</span> mmsawt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we will incorporate design effects as well:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>fit3<span class="ot">&lt;-</span><span class="fu">svyglm</span>(bmi<span class="sc">~</span>educ<span class="sc">+</span>agec,</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">design =</span> des, </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">family=</span>gaussian)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now I make a table to show the results of the three models:</p>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stargazer</span>(fit1, fit2, fit3,</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">style=</span><span class="st">"demography"</span>, <span class="at">type=</span><span class="st">"html"</span>,</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">column.labels =</span> <span class="fu">c</span>(<span class="st">"OLS"</span>, <span class="st">"Weights Only"</span>, <span class="st">"Survey Design"</span>),</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="st">"Regression models for BMI using survey data - BRFSS 2016"</span>, </span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">covariate.labels=</span><span class="fu">c</span>(<span class="st">"PrimarySchool"</span>, <span class="st">"SomeHS"</span>, <span class="st">"SomeColl"</span>, <span class="st">"CollGrad"</span>, <span class="st">"Age 24-39"</span>,<span class="st">"Age 39-59"</span> ,<span class="st">"Age 59-79"</span>, <span class="st">"Age 80+"</span>), </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">keep.stat=</span><span class="st">"n"</span>,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">model.names=</span>F, </span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">align=</span>T,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">ci=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<table style="text-align:center">
<caption>
<strong>Regression models for BMI using survey data - BRFSS 2016</strong>
</caption>
<tbody><tr>
<td colspan="4" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td colspan="3">
bmi
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
OLS
</td>
<td>
Weights Only
</td>
<td>
Survey Design
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
Model 1
</td>
<td>
Model 2
</td>
<td>
Model 3
</td>
</tr>
<tr>
<td colspan="4" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
PrimarySchool
</td>
<td>
-0.267
</td>
<td>
0.201<sup>*</sup>
</td>
<td>
0.201
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(-0.537, 0.003)
</td>
<td>
(0.014, 0.389)
</td>
<td>
(-0.547, 0.950)
</td>
</tr>
<tr>
<td style="text-align:left">
SomeHS
</td>
<td>
-0.465<sup>***</sup>
</td>
<td>
-0.556<sup>***</sup>
</td>
<td>
-0.556
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(-0.698, -0.233)
</td>
<td>
(-0.718, -0.394)
</td>
<td>
(-1.219, 0.107)
</td>
</tr>
<tr>
<td style="text-align:left">
SomeColl
</td>
<td>
-0.593<sup>***</sup>
</td>
<td>
-0.693<sup>***</sup>
</td>
<td>
-0.693<sup>*</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(-0.824, -0.361)
</td>
<td>
(-0.854, -0.533)
</td>
<td>
(-1.352, -0.034)
</td>
</tr>
<tr>
<td style="text-align:left">
CollGrad
</td>
<td>
-1.953<sup>***</sup>
</td>
<td>
-2.186<sup>***</sup>
</td>
<td>
-2.186<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(-2.182, -1.724)
</td>
<td>
(-2.346, -2.027)
</td>
<td>
(-2.835, -1.538)
</td>
</tr>
<tr>
<td style="text-align:left">
Age 24-39
</td>
<td>
2.966<sup>***</sup>
</td>
<td>
3.005<sup>***</sup>
</td>
<td>
3.005<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(2.837, 3.095)
</td>
<td>
(2.901, 3.108)
</td>
<td>
(2.757, 3.252)
</td>
</tr>
<tr>
<td style="text-align:left">
Age 39-59
</td>
<td>
3.883<sup>***</sup>
</td>
<td>
3.838<sup>***</sup>
</td>
<td>
3.838<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(3.761, 4.005)
</td>
<td>
(3.737, 3.938)
</td>
<td>
(3.608, 4.067)
</td>
</tr>
<tr>
<td style="text-align:left">
Age 59-79
</td>
<td>
3.194<sup>***</sup>
</td>
<td>
3.219<sup>***</sup>
</td>
<td>
3.219<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(3.074, 3.315)
</td>
<td>
(3.115, 3.323)
</td>
<td>
(2.995, 3.443)
</td>
</tr>
<tr>
<td style="text-align:left">
Age 80+
</td>
<td>
0.871<sup>***</sup>
</td>
<td>
0.954<sup>***</sup>
</td>
<td>
0.954<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.718, 1.024)
</td>
<td>
(0.794, 1.115)
</td>
<td>
(0.572, 1.337)
</td>
</tr>
<tr>
<td style="text-align:left">
Constant
</td>
<td>
26.286<sup>***</sup>
</td>
<td>
26.213<sup>***</sup>
</td>
<td>
26.213<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(26.036, 26.537)
</td>
<td>
(26.038, 26.389)
</td>
<td>
(25.538, 26.889)
</td>
</tr>
<tr>
<td style="text-align:left">
<em>N</em>
</td>
<td>
172,719
</td>
<td>
172,719
</td>
<td>
172,719
</td>
</tr>
<tr>
<td colspan="4" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td colspan="4" style="text-align:left">
<sup><em></em></sup><em>p &lt; .05; <sup><strong></strong></sup><strong>p &lt; .01; <sup></sup></strong></em>p &lt; .001
</td>
</tr>

</tbody></table>
<p>Notice, the results for the education levels are much <em>less</em> significant than the were with either of the other two analysis. This is because those models had standard errors for the parameters that were too small. You see all the standard errors are larger and the T statistics are smaller.</p>
<p>Which shows the same <span class="math inline">\(\beta\)</span>’s between the survey design model and the weighted model but the standard errors are larger in the survey model, so the test statistics are more conservative (smaller t statistics).</p>
<p>While in this simple model, our overall interpretation of the effects do not change (positive effects of education, negative effects of age), it is entirely possible that they could once we include our survey design effects.</p>
<p>It may be informative to plot the results of the models to see how different the coefficients are from one another:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>coefs<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">coefs=</span><span class="fu">c</span>(<span class="fu">coef</span>(fit1)[<span class="sc">-</span><span class="dv">1</span>], <span class="fu">coef</span>(fit3)[<span class="sc">-</span><span class="dv">1</span>]),</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mod=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Non Survey Model"</span>, <span class="dv">8</span>),<span class="fu">rep</span>(<span class="st">"Survey Model"</span>, <span class="dv">8</span>)),</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">effect=</span><span class="fu">rep</span>(<span class="fu">names</span>(<span class="fu">coef</span>(fit1)[<span class="sc">-</span><span class="dv">1</span>]), <span class="dv">2</span>))</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>coefs<span class="sc">%&gt;%</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>( <span class="at">x=</span>effect,</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y=</span>coefs,</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">group=</span>effect,</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color=</span>effect,</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">shape=</span>mod),</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">position=</span><span class="fu">position_jitterdodge</span>(<span class="at">jitter.width =</span> <span class="dv">1</span>),</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">size=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Regression Coefficient"</span>)<span class="sc">+</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Beta"</span>)<span class="sc">+</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope=</span><span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">"Comparison of Survey and Non-Survey Regression effects"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="EX2_surveystats_22_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Which shows us that the betas are similar but have some differences between the two models.</p>
</section>
<section id="creating-survey-estimates-for-places" class="level2">
<h2 class="anchored" data-anchor-id="creating-survey-estimates-for-places">Creating Survey estimates for places</h2>
<p>One of the coolest ways to use the BRFSS is to calculate estimates for places, and by demographic characteristics withing places. Again, we use <code>svyby()</code> to do this, but now we calculate obesity rates by sex within cities.</p>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>citytab<span class="ot">&lt;-</span><span class="fu">svyby</span>(<span class="sc">~</span>obese,</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>               <span class="sc">~</span>mmsaname,</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">design=</span>des,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">FUN =</span> svymean,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">na.rm=</span>T )</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(citytab[ <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, ],</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">digits=</span><span class="dv">3</span>,</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">caption =</span> <span class="st">"Obesity Estimats for TX MSAs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table">
<caption>Obesity Estimats for TX MSAs</caption>
<colgroup>
<col style="width: 45%">
<col style="width: 45%">
<col style="width: 4%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">mmsaname</th>
<th style="text-align: right;">obese</th>
<th style="text-align: right;">se</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Aberdeen, SD, Micropolitan Statistical Area</td>
<td style="text-align: left;">Aberdeen, SD, Micropolitan Statistical Area</td>
<td style="text-align: right;">0.292</td>
<td style="text-align: right;">0.027</td>
</tr>
<tr class="even">
<td style="text-align: left;">Akron, OH, Metropolitan Statistical Area</td>
<td style="text-align: left;">Akron, OH, Metropolitan Statistical Area</td>
<td style="text-align: right;">0.312</td>
<td style="text-align: right;">0.023</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Albany-Schenectady-Troy, NY, Metropolitan Statistical Area</td>
<td style="text-align: left;">Albany-Schenectady-Troy, NY, Metropolitan Statistical Area</td>
<td style="text-align: right;">0.249</td>
<td style="text-align: right;">0.019</td>
</tr>
<tr class="even">
<td style="text-align: left;">Albuquerque, NM, Metropolitan Statistical Area</td>
<td style="text-align: left;">Albuquerque, NM, Metropolitan Statistical Area</td>
<td style="text-align: right;">0.297</td>
<td style="text-align: right;">0.018</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Anchorage, AK, Metropolitan Statistical Area</td>
<td style="text-align: left;">Anchorage, AK, Metropolitan Statistical Area</td>
<td style="text-align: right;">0.325</td>
<td style="text-align: right;">0.021</td>
</tr>
<tr class="even">
<td style="text-align: left;">Atlanta-Sandy Springs-Alpharetta, GA, Metropolitan Statistical Area</td>
<td style="text-align: left;">Atlanta-Sandy Springs-Alpharetta, GA, Metropolitan Statistical Area</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">0.014</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Augusta-Richmond County, GA-SC, Metropolitan Statistical Area</td>
<td style="text-align: left;">Augusta-Richmond County, GA-SC, Metropolitan Statistical Area</td>
<td style="text-align: right;">0.397</td>
<td style="text-align: right;">0.033</td>
</tr>
<tr class="even">
<td style="text-align: left;">Austin-Round Rock-Georgetown, TX, Metropolitan Statistical Area</td>
<td style="text-align: left;">Austin-Round Rock-Georgetown, TX, Metropolitan Statistical Area</td>
<td style="text-align: right;">0.273</td>
<td style="text-align: right;">0.015</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Baltimore-Columbia-Towson, MD, Metropolitan Statistical Area</td>
<td style="text-align: left;">Baltimore-Columbia-Towson, MD, Metropolitan Statistical Area</td>
<td style="text-align: right;">0.322</td>
<td style="text-align: right;">0.009</td>
</tr>
<tr class="even">
<td style="text-align: left;">Baton Rouge, LA, Metropolitan Statistical Area</td>
<td style="text-align: left;">Baton Rouge, LA, Metropolitan Statistical Area</td>
<td style="text-align: right;">0.348</td>
<td style="text-align: right;">0.021</td>
</tr>
</tbody>
</table>
</div>
<section id="using-srvyr" class="level3">
<h3 class="anchored" data-anchor-id="using-srvyr">Using srvyr</h3>
<p>There’s a new package called <code>srvyr</code> that incorporates the survey analysis stuff into the <code>dplyr</code> universe:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(srvyr)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>brfsurv<span class="ot">&lt;-</span>brfss20<span class="sc">%&gt;%</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_survey_design</span>(<span class="at">strata=</span>ststr,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">weights=</span>mmsawt )</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>brfsurv<span class="sc">%&gt;%</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mmsaname)<span class="sc">%&gt;%</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">obprev =</span> <span class="fu">survey_mean</span>(obese, <span class="at">na.rm=</span>T))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="replicate-weights" class="level2">
<h2 class="anchored" data-anchor-id="replicate-weights">Replicate Weights</h2>
<p>If your dataset comes with <em>replicate weights</em>, you have to specify the survey design slightly differently. Here is an example using the IPUMS CPS data. For this data, you can get information <a href="https://cps.ipums.org/cps/repwt.shtml">here</a>, but you must consult your specific data source for the appropriate information for your data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">url</span>(<span class="st">"https://github.com/coreysparks/data/blob/master/cpsmar10tx.Rdata?raw=true"</span>))</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(cpsmar10tx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] "year"     "serial"   "hwtsupp"  "repwt"    "statefip" "metarea" 
  [7] "foodstmp" "REPWT1"   "REPWT2"   "REPWT3"   "REPWT4"   "REPWT5"  
 [13] "REPWT6"   "REPWT7"   "REPWT8"   "REPWT9"   "REPWT10"  "REPWT11" 
 [19] "REPWT12"  "REPWT13"  "REPWT14"  "REPWT15"  "REPWT16"  "REPWT17" 
 [25] "REPWT18"  "REPWT19"  "REPWT20"  "REPWT21"  "REPWT22"  "REPWT23" 
 [31] "REPWT24"  "REPWT25"  "REPWT26"  "REPWT27"  "REPWT28"  "REPWT29" 
 [37] "REPWT30"  "REPWT31"  "REPWT32"  "REPWT33"  "REPWT34"  "REPWT35" 
 [43] "REPWT36"  "REPWT37"  "REPWT38"  "REPWT39"  "REPWT40"  "REPWT41" 
 [49] "REPWT42"  "REPWT43"  "REPWT44"  "REPWT45"  "REPWT46"  "REPWT47" 
 [55] "REPWT48"  "REPWT49"  "REPWT50"  "REPWT51"  "REPWT52"  "REPWT53" 
 [61] "REPWT54"  "REPWT55"  "REPWT56"  "REPWT57"  "REPWT58"  "REPWT59" 
 [67] "REPWT60"  "REPWT61"  "REPWT62"  "REPWT63"  "REPWT64"  "REPWT65" 
 [73] "REPWT66"  "REPWT67"  "REPWT68"  "REPWT69"  "REPWT70"  "REPWT71" 
 [79] "REPWT72"  "REPWT73"  "REPWT74"  "REPWT75"  "REPWT76"  "REPWT77" 
 [85] "REPWT78"  "REPWT79"  "REPWT80"  "REPWT81"  "REPWT82"  "REPWT83" 
 [91] "REPWT84"  "REPWT85"  "REPWT86"  "REPWT87"  "REPWT88"  "REPWT89" 
 [97] "REPWT90"  "REPWT91"  "REPWT92"  "REPWT93"  "REPWT94"  "REPWT95" 
[103] "REPWT96"  "REPWT97"  "REPWT98"  "REPWT99"  "REPWT100" "REPWT101"
[109] "REPWT102" "REPWT103" "REPWT104" "REPWT105" "REPWT106" "REPWT107"
[115] "REPWT108" "REPWT109" "REPWT110" "REPWT111" "REPWT112" "REPWT113"
[121] "REPWT114" "REPWT115" "REPWT116" "REPWT117" "REPWT118" "REPWT119"
[127] "REPWT120" "REPWT121" "REPWT122" "REPWT123" "REPWT124" "REPWT125"
[133] "REPWT126" "REPWT127" "REPWT128" "REPWT129" "REPWT130" "REPWT131"
[139] "REPWT132" "REPWT133" "REPWT134" "REPWT135" "REPWT136" "REPWT137"
[145] "REPWT138" "REPWT139" "REPWT140" "REPWT141" "REPWT142" "REPWT143"
[151] "REPWT144" "REPWT145" "REPWT146" "REPWT147" "REPWT148" "REPWT149"
[157] "REPWT150" "REPWT151" "REPWT152" "REPWT153" "REPWT154" "REPWT155"
[163] "REPWT156" "REPWT157" "REPWT158" "REPWT159" "REPWT160" "month"   
[169] "pernum"   "wtsupp"   "relate"   "age"      "sex"      "race"    
[175] "marst"    "offpov"   "MIGRATE1"</code></pre>
</div>
</div>
<p>So we see the replicate weights are in columns 8 through 167 in the data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">#simple binary outcome</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>cpsmar10tx<span class="sc">$</span>poverty<span class="ot">&lt;-</span><span class="fu">ifelse</span>(cpsmar10tx<span class="sc">$</span>offpov<span class="sc">==</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Replicate weight design - I got these details from the data source, you should too</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>des2<span class="ot">&lt;-</span><span class="fu">svrepdesign</span>( <span class="at">data =</span> cpsmar10tx,</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">repweights =</span> cpsmar10tx[, <span class="fu">c</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">167</span>)]  ,</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">weights =</span> <span class="sc">~</span>wtsupp ,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">type=</span><span class="st">"JK1"</span>,</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">scale=</span>.<span class="dv">025</span>)</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>des2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: svrepdesign.default(data = cpsmar10tx, repweights = cpsmar10tx[, 
    c(8:167)], weights = ~wtsupp, type = "JK1", scale = 0.025)
Unstratified cluster jacknife (JK1) with 160 replicates.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Without design</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(cpsmar10tx<span class="sc">$</span>poverty))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
        0         1 
0.8374617 0.1625383 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co">#with design</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">svytable</span>(<span class="sc">~</span>poverty,</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">design =</span> des2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>poverty
        0         1 
0.8481106 0.1518894 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Again, using the mean</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(cpsmar10tx<span class="sc">$</span>poverty)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1625383</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Using the design. This would be an official estimate of poverty in TX in 2010:</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">svymean</span>(<span class="sc">~</span>poverty, </span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">design=</span>des2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           mean    SE
poverty 0.15189 0.007</code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>